name: full
on:
  pull_request:
    paths:
      - '**/*.tf'

jobs:
  check-changed-files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Find changed .tf files
        id: changed-files
        run: |
          git fetch origin main
          CHANGED_FILES=$(git diff --name-only origin/main | grep '\.tf$' || true)
          if [ -z "$CHANGED_FILES" ]; then
            echo "No Terraform files changed."
            exit 0
          else
            echo "::set-output name=files::$CHANGED_FILES"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Checkov
        run: pip install checkov

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_wrapper: false

      - name: Install TFLint
        run: |
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash

      - name: Run Terraform fmt
        id: terraform-fmt
        run: |
          for file in ${{ steps.changed-files.outputs.files }}; do
            terraform fmt -check -diff $file || exit 1
          done

      - name: Run TFLint
        id: tflint
        run: |
          for file in ${{ steps.changed-files.outputs.files }}; do
            tflint $file || exit 1
          done

      - name: Run Checkov
        id: checkov
        run: |
          for file in ${{ steps.changed-files.outputs.files }}; do
            checkov -f $file || exit 1
          done

      - name: Post Check Results as PR comment
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=$(jq --raw-output '.[0].number' <<< "$(gh pr list --json number --state open --limit 1)")
          FMT_STATUS="âœ… Terraform fmt check successful"
          TFLINT_STATUS="âœ… TFLint check successful"
          CHECKOV_STATUS="âœ… Checkov scan successful"

          if [ ${{ steps.terraform-fmt.outcome }} != "success" ]; then
            FMT_STATUS="âŒ Terraform fmt check failed - [View Details]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)"
          fi

          if [ ${{ steps.tflint.outcome }} != "success" ]; then
            TFLINT_STATUS="âŒ TFLint check failed - [View Details]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)"
          fi

          if [ ${{ steps.checkov.outcome }} != "success" ]; then
            CHECKOV_STATUS="âŒ Checkov scan failed - [View Details]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)"
          fi

          if [ "$FMT_STATUS" == "âœ… Terraform fmt check successful" ] && [ "$TFLINT_STATUS" == "âœ… TFLint check successful" ] && [ "$CHECKOV_STATUS" == "âœ… Checkov scan successful" ]; then
            FINAL_STATUS="All checks passed successfully! Good to go! ðŸŽ‰"
          else
            FINAL_STATUS="One or more checks failed. Please address the issues."
          fi
COMMENT=$(printf "### Check Results\n%s\n%s\n%s\n\n**%s**" "$FMT_STATUS" "$TFLINT_STATUS" "$CHECKOV_STATUS" "$FINAL_STATUS")

echo "$COMMENT" | gh pr comment $PR_NUMBER --body -

